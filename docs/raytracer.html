<!DOCTYPE html>

<html>
<head>
  <title>raytracer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="raytracer.html">
                raytracer.js
              </a>
            
              
              <a class="source" href="vector.html">
                vector.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>raytracer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> c = document.getElementById(<span class="string">'c'</span>),
    width = <span class="number">100</span>,
    height = <span class="number">100</span>;

c.width = width;
c.height = height;

<span class="keyword">var</span> intersection = {
    sphere: sphereIntersection
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Get a context in order to generate a proper data array. We aren&#39;t going to
use traditional Canvas drawing functions like <code>fillRect</code> - instead this
raytracer will directly compute pixel data and then put it into an image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> ctx = c.getContext(<span class="string">'2d'</span>),
    data = ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, width, height);

<span class="keyword">var</span> light = { x: <span class="number">30</span>, y: <span class="number">30</span>, z: <span class="number">10</span> };

<span class="keyword">var</span> objects = [
    {
        type: <span class="string">'sphere'</span>,
        vector: {
            x: <span class="number">0</span>,
            y: <span class="number">0</span>,
            z: <span class="number">0</span>
        },
        radius: <span class="number">9</span>
    }
];

<span class="keyword">var</span> camera = {
    point: {
        x: <span class="number">8</span>,
        y: <span class="number">3</span>,
        z: <span class="number">3</span>
    },
    forward: unitVector({
        x: <span class="number">1</span>,
        y: <span class="number">1</span>,
        z: <span class="number">1</span>
    }),
    lookAt: {
        x: <span class="number">0</span>,
        y: <span class="number">0</span>,
        z: <span class="number">0</span>
    }
};

camera.right = unitVector(crossProduct(camera.point, { x: <span class="number">0</span>, y: -<span class="number">1</span>, z: <span class="number">0</span> }));
camera.up = unitVector(crossProduct(camera.point, camera.right));</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1>Throwing Rays</h1>
<p>For each pixel in the canvas, there needs to be at least one ray of light
that determines its color by bouncing through the scene.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> index, ray, color;
<span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; width; x++) {
    <span class="keyword">for</span> (<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; height; y++) {

        index = (x * <span class="number">4</span>) + (y * width * <span class="number">4</span>),
        ray = {
            vector: unitVector(add(camera.forward,
                add(scale(camera.right, (x - width / <span class="number">2</span>) / <span class="number">4</span>),
                    scale(camera.up, (y - height/<span class="number">2</span>) / <span class="number">4</span>))))
        };

        color = trace(ray, <span class="number">1</span>, <span class="number">1</span>);
        data.data[index + <span class="number">0</span>] = color[<span class="number">0</span>];
        data.data[index + <span class="number">1</span>] = color[<span class="number">1</span>];
        data.data[index + <span class="number">2</span>] = color[<span class="number">2</span>];
        data.data[index + <span class="number">3</span>] = color[<span class="number">3</span>];
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Now that each ray has returned and populated the <code>data</code> array with
correctly lit colors, fill the canvas with the generated data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ctx.putImageData(data, <span class="number">0</span>, <span class="number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Sphere</h2>
<p>Spheres are one of the simplest objects for rays to interact with, since
the geometrical math for finding intersections and reflections with them
is pretty straightforward.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">sphereIntersection</span><span class="params">(sphere, ray)</span> {</span>

    <span class="keyword">var</span> eye_to_center = subtract(camera.point, sphere.vector),</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>the length of a
hypoteneuse of a right triangle with points
at the eye and the center of the circle, and a right
angle at the other point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        v = dotProduct(ray.vector, eye_to_center),
        eoDot = dotProduct(eye_to_center, eye_to_center),</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>the radius of the sphere, squared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        r2 = sphere.radius * sphere.radius,
        discriminant =  r2 - eoDot + (v * v);

    <span class="keyword">var</span> sqrt = Math.sqrt(discriminant);
    <span class="keyword">if</span> (discriminant) <span class="keyword">return</span> -v - sqrt;
    <span class="keyword">else</span> <span class="keyword">if</span> (discriminant) <span class="keyword">return</span> -v + sqrt;
    <span class="keyword">else</span> <span class="keyword">return</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">sphereNormal</span><span class="params">(sphere, pos)</span> {</span>
    <span class="keyword">return</span> scale(<span class="keyword">this</span>.vectorSub(pos, sphere.point), <span class="number">1</span> / sphere.radius);
}

<span class="function"><span class="keyword">function</span> <span class="title">trace</span><span class="params">(ray, depth, current_reflectance)</span> {</span>
    <span class="keyword">if</span> (depth &gt; <span class="number">10</span>) <span class="keyword">return</span>;

    ray.hit = <span class="literal">null</span>;

    <span class="keyword">var</span> dist = intersection[objects[<span class="number">0</span>].type](objects[<span class="number">0</span>], ray);

    <span class="keyword">if</span> (dist) {
        <span class="keyword">var</span> pos = add(camera.point, scale(ray.vector, dist));
    }

    <span class="keyword">if</span> (dist) {
        <span class="keyword">return</span> [<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">255</span>];
    } <span class="keyword">else</span> {
        <span class="keyword">return</span> [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>];
    }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
